SELECT DISTINCT ON (deployments.environment_id) ci_variables.* FROM "ci_variables" INNER JOIN "projects" ON "projects"."id" = "ci_variables"."project_id" INNER JOIN "environments" ON "environments"."project_id" = "projects"."id" INNER JOIN "deployments" ON "deployments"."environment_id" = "environments"."id" AND "deployments"."status" IN ($1, $2, $3, $4) WHERE ("environments"."state" IN ('available')) AND "deployments"."status" = $5 AND "ci_variables"."key" = $6 AND "environments"."id" NOT IN (SELECT DISTINCT ON (deployments.environment_id) deployments.environment_id FROM "ci_pipeline_variables" INNER JOIN "ci_pipelines" ON "ci_pipelines"."id" = "ci_pipeline_variables"."pipeline_id" INNER JOIN "ci_builds" ON "ci_builds"."commit_id" = "ci_pipelines"."id" AND "ci_builds"."type" = $7 INNER JOIN "deployments" ON "deployments"."deployable_id" = "ci_builds"."id" AND "deployments"."deployable_type" = $8 INNER JOIN "environments" ON "environments"."id" = "deployments"."environment_id" INNER JOIN "deployments" "last_visible_deployments_environments" ON "last_visible_deployments_environments"."environment_id" = "environments"."id" AND "last_visible_deployments_environments"."status" IN ($9, $10, $11, $12) WHERE ("environments"."state" IN ('available')) AND "deployments"."status" = $13 AND "ci_pipeline_variables"."key" = $14 ORDER BY deployments.environment_id, deployments.id DESC) /*application:test,controller:application_settings,action:usage_data,correlation_id:6a0c0fa1ca2505711e59296537dcdff3*/